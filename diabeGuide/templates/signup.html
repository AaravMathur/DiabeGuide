{% extends "base.html" %}
{% block content %}
<div class="auth-container">
    <h2>Sign Up</h2>
    
    <form method="POST" action="{{ url_for('auth.signup') }}" id="signup-form">
        <div class="form-group">
            <label for="username">Username:</label>
            <input type="text" id="username" name="username" value="{{ username or '' }}" required {% if show_otp %}readonly{% endif %} placeholder="Enter username">
        </div>
        
        <div class="form-group">
            <label for="email">Email:</label>
            <input type="email" id="email" name="email" value="{{ email or '' }}" required {% if show_otp %}readonly{% endif %} placeholder="Enter email">
        </div>
        
        <div class="form-group" id="password-group">
            <label for="password">Password:</label>
            <input type="password" id="password" name="password" required placeholder="Enter password">
        </div>
        
        <!-- OTP Verification Section (hidden initially) -->
        <div id="otp-section" class="form-group" style="display: none;">
            <label for="otp">Enter OTP:</label>
            <input type="text" id="otp" name="otp" pattern="[0-9]{6}" maxlength="6" placeholder="Enter 6-digit OTP" autocomplete="off">
            <small class="form-help">Check your email for the verification code</small>
            <button type="button" id="resend-otp-btn" class="resend-otp-btn">Resend OTP</button>
            <div id="otp-message" class="form-help" style="margin-top: 0.5rem; font-weight: 600;"></div>
        </div>
        
        <button type="submit" id="submit-btn">Sign Up</button>
        
        <input type="hidden" name="verify_otp" value="false" id="verify_otp_input">
    </form>
    
    <p>Already have an account? <a href="{{ url_for('auth.login') }}">Login</a></p>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const submitBtn = document.getElementById('submit-btn');
    const passwordGroup = document.getElementById('password-group');
    const passwordInput = document.getElementById('password');
    const otpSection = document.getElementById('otp-section');
    const verifyOtpInput = document.getElementById('verify_otp_input');

    // This block now contains ALL logic related to the OTP functionality
    if ({{ show_otp | tojson }}) {
        // 1. Configure the form for OTP entry
        passwordGroup.style.display = 'none';
        passwordInput.required = false;
        otpSection.style.display = 'block';
        submitBtn.textContent = 'Verify & Sign Up';
        verifyOtpInput.value = 'true';

        // 2. Get OTP-specific elements
        const otpInput = document.getElementById('otp');
        const resendBtn = document.getElementById('resend-otp-btn');
        const otpMessageEl = document.getElementById('otp-message');

        // 3. Set focus and requirement for the OTP input
        otpInput.required = true;
        otpInput.focus();

        // 4. Add listener to allow only numbers in OTP input
        otpInput.addEventListener('input', function(e) {
            e.target.value = e.target.value.replace(/[^0-9]/g, '');
        });

        // 5. Add listener for the "Resend OTP" button
        resendBtn.addEventListener('click', function() {
            resendBtn.disabled = true;
            resendBtn.textContent = 'Sending...';
            otpMessageEl.textContent = ''; // Clear previous messages

            fetch('{{ url_for("auth.resend_otp") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({}) // Add empty body for best practice
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    otpMessageEl.style.color = 'var(--primary-color)';
                    otpMessageEl.textContent = 'A new OTP has been sent to your email.';
                    
                    // Start cooldown timer ONLY on success
                    let countdown = 30;
                    resendBtn.textContent = `Resend in ${countdown}s`;
                    const interval = setInterval(() => {
                        countdown--;
                        if (countdown > 0) {
                            resendBtn.textContent = `Resend in ${countdown}s`;
                        } else {
                            clearInterval(interval);
                            resendBtn.textContent = 'Resend OTP';
                            resendBtn.disabled = false;
                        }
                    }, 1000);
                } else {
                    // Handle server-side failure (e.g., session expired)
                    otpMessageEl.style.color = 'var(--danger-color)';
                    otpMessageEl.textContent = data.error || 'Failed to resend OTP. Please try again.';
                    resendBtn.textContent = 'Resend OTP';
                    resendBtn.disabled = false;
                }
            })
            .catch(error => {
                // Handle network/fetch error
                console.error('Error:', error);
                otpMessageEl.style.color = 'var(--danger-color)';
                otpMessageEl.textContent = 'An error occurred. Please check your connection and try again.';
                resendBtn.textContent = 'Resend OTP';
                resendBtn.disabled = false;
            });
        });
    }
});
</script>

<style>
.resend-otp-btn {
    margin-top: 0.5rem;
    padding: 0.5rem 1rem;
    background: transparent;
    border: 2px solid var(--primary-color);
    color: var(--primary-color);
    border-radius: var(--radius-md);
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: 600;
    transition: all 0.3s ease;
}

.resend-otp-btn:hover {
    background: var(--primary-color);
    color: white;
}

.resend-otp-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.form-help {
    display: block;
    margin-top: 0.25rem;
    font-size: 0.85rem;
    color: var(--text-secondary);
}

#otp-section {
    animation: slideDown 0.3s ease-out;
    padding: 1rem;
    background: var(--bg-tertiary);
    border-radius: var(--radius-md);
    border: 2px solid var(--primary-color);
    margin-bottom: 1rem;
}

#otp-section input {
    font-size: 1.5rem;
    letter-spacing: 0.5rem;
    text-align: center;
    font-weight: bold;
}

input[readonly] {
    background-color: var(--bg-tertiary);
    cursor: not-allowed;
}
</style>
{% endblock %}
